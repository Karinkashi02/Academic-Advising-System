<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Profile | Advisor Dashboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --blue-primary:#3498db;
            --blue-dark:#2980b9;
            --bg-light:#f8f9fa;
            --bg-card:#fff;
            --text-dark:#2c3e50;
            --text-muted:#7f8c8d;
            --danger:#e74c3c;
            --success:#27ae60;
            --border:#dfe6e9;
            --profile-gradient: linear-gradient(135deg,#3498db 0%,#2980b9 100%);
        }
        *{box-sizing:border-box;font-family:Inter, sans-serif}
        body{margin:0;background:var(--bg-light);color:var(--text-dark);min-height:100vh;overflow-x:hidden}
        .dashboard-container{display:flex;min-height:100vh}
        .sidebar{width:260px;background:#2c3e50;color:#ecf0f1;display:flex;flex-direction:column;position:fixed;height:100vh}
        .sidebar-header{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
        .logo-main{display:flex;align-items:center;justify-content:center;gap:8px}
        .logo-main span{color:var(--blue-primary);font-weight:700;font-size:18px}
        .sidebar-nav{padding:12px 0;flex:1}
        .nav-item{display:flex;align-items:center;padding:12px 20px;color:var(--sidebar-text);text-decoration:none;gap:10px}
        .nav-item:hover{background:rgba(52,152,219,.06);border-left:3px solid var(--blue-primary)}
        .nav-item.active{background:rgba(52,152,219,.12);border-left:3px solid var(--blue-primary)}
        .main-content{flex:1;margin-left:260px;display:flex;flex-direction:column}
        .header{background:var(--bg-card);padding:18px 30px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
        .header h1{font-size:20px;margin:0}
        .header-actions{display:flex;gap:12px;align-items:center}
        .profile-btn,.logout-btn{width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#f3f6f9;border:1px solid var(--border);cursor:pointer}
        .content{padding:28px}
        .profile-card{background:var(--bg-card);border-radius:10px;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.06);border-top:3px solid var(--blue-primary)}
        .profile-header{background:var(--profile-gradient);padding:36px 28px;text-align:center;color:white}
        .profile-avatar{width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:36px;font-weight:700}
        .profile-title{font-size:26px;margin-bottom:10px}
        .profile-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.15);padding:8px 14px;border-radius:20px;font-weight:600}
        .profile-content{padding:26px}
        .section-title{display:flex;align-items:center;gap:10px;font-size:18px;color:var(--blue-primary);margin-bottom:18px}
        .detail-row{display:flex;gap:16px;padding:14px 0;border-bottom:1px solid rgba(235,245,255,1)}
        .detail-label{width:220px;flex-shrink:0;font-weight:600;display:flex;align-items:center;gap:10px}
        .detail-value{flex:1;color:var(--text-dark)}
        .role-badge{display:inline-flex;align-items:center;gap:8px;background:var(--profile-gradient);color:white;padding:8px 12px;border-radius:18px}
        .action-buttons{display:flex;gap:12px;margin-top:22px}
        .btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
        .btn-primary{background:var(--blue-primary);color:white}
        .btn-secondary{background:#f3f6f9;border:1px solid var(--border);color:var(--text-dark)}
        .muted{color:var(--text-muted)}
        label{font-weight:600;display:block;margin-bottom:6px}
        input[type="text"], input[type="email"], textarea { width:100%; padding:10px;border:1px solid var(--border);border-radius:8px; font-size:14px }
        textarea { min-height:100px; resize:vertical }
        .toast { position: fixed; right: 20px; bottom: 20px; padding:12px 16px; border-radius:8px; color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.12); display:none; z-index:1100 }
        .toast.success { background:var(--success) }
        .toast.error { background:var(--danger) }

        /* modal */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1200;padding:16px}
        .modal{background:white;border-radius:10px;max-width:720px;width:100%;max-height:90vh;overflow:auto}
        .modal-header{padding:18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-body{padding:18px}
        .modal-footer{padding:18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}

        /* responsive */
        @media (max-width:992px){
            .sidebar{width:72px}
            .main-content{margin-left:72px}
            .detail-label{width:140px}
        }
        @media (max-width:640px){
            .detail-row{flex-direction:column}
            .detail-label{width:100%}
        }
        a:focus, button:focus, input:focus, textarea:focus { outline:3px solid rgba(52,152,219,.15); outline-offset:2px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" aria-label="Sidebar navigation">
            <div class="sidebar-header">
                <div class="logo-main">Advise<span>.</span></div>
            </div>
            <nav class="sidebar-nav" aria-label="Primary">
                <a href="advisor_dashboard.html" class="nav-item active"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="manage_student.html" class="nav-item"><i class="fas fa-users"></i><span>My Students</span></a>
                <a href="view_advising_session.html" class="nav-item"><i class="fas fa-calendar-check"></i><span>Sessions</span></a>
                <a href="advisor_report.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header" role="banner">
                <h1>My Profile</h1>
                <div class="header-actions">
                    <button class="profile-btn" id="profileHomeBtn" title="Dashboard" aria-label="Dashboard"><i class="fas fa-tachometer-alt"></i></button>
                    <button class="logout-btn" id="logoutBtn" title="Logout" aria-label="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <main class="content" role="main">
                <section class="profile-card" aria-labelledby="profileHeading">
                    <div class="profile-header">
                        <div class="profile-avatar" id="avatar">AD</div>
                        <h2 class="profile-title" id="profileName">Advisor</h2>
                        <div class="profile-badge" id="profileDept">Academic Advisor</div>
                    </div>

                    <div class="profile-content">
                        <h3 class="section-title"><i class="fas fa-user-circle" aria-hidden="true"></i> Profile Details</h3>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-envelope" aria-hidden="true"></i> Email</div>
                            <div class="detail-value" id="displayEmail">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-user" aria-hidden="true"></i> Full name</div>
                            <div class="detail-value" id="displayFullName">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-university" aria-hidden="true"></i> Department</div>
                            <div class="detail-value" id="displayDepartment">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-lightbulb" aria-hidden="true"></i> Expertise</div>
                            <div class="detail-value" id="displayExpertise">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-clock" aria-hidden="true"></i> Office hours</div>
                            <div class="detail-value" id="displayOfficeHours">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-phone" aria-hidden="true"></i> Phone</div>
                            <div class="detail-value" id="displayPhone">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Office location</div>
                            <div class="detail-value" id="displayOfficeLocation">—</div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-label"><i class="fas fa-users" aria-hidden="true"></i> Students</div>
                            <div class="detail-value" id="displayNumStd">—</div>
                        </div>

                        <div class="action-buttons" role="group" aria-label="Profile actions">
                            <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                            <a class="btn btn-secondary" href="advisor_dashboard.html">Back to Dashboard</a>
                        </div>
                    </div>
                </section>
            </main>

            <footer style="padding:14px;text-align:center;border-top:1px solid var(--border);background:#fff">© 2025 Advising System — University Academic Services</footer>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" role="document" aria-labelledby="modalTitle">
            <div class="modal-header">
                <h3 id="modalTitle">Edit Profile</h3>
                <button id="modalCloseBtn" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm" novalidate>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div>
                            <label for="firstName">First name *</label>
                            <input id="firstName" name="firstName" type="text" required />
                        </div>
                        <div>
                            <label for="lastName">Last name *</label>
                            <input id="lastName" name="lastName" type="text" required />
                        </div>
                    </div>

                    <div style="margin-top:12px">
                        <label for="email">Email *</label>
                        <input id="email" name="email" type="email" required />
                    </div>

                    <div style="margin-top:12px">
                        <label for="department">Department</label>
                        <input id="department" name="department" type="text" />
                    </div>

                    <div style="margin-top:12px">
                        <label for="expertise">Expertise</label>
                        <textarea id="expertise" name="expertise"></textarea>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
                        <div>
                            <label for="officeHours">Office hours</label>
                            <textarea id="officeHours" name="officeHours"></textarea>
                        </div>
                        <div>
                            <label for="officeLoc">Office location</label>
                            <input id="officeLoc" name="officeLoc" type="text" />
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
                        <div>
                            <label for="phoneNum">Phone</label>
                            <input id="phoneNum" name="phoneNum" type="text" />
                        </div>
                        <div>
                            <label for="password">New password (optional)</label>
                            <input id="password" name="password" type="password" />
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEdit">Cancel</button>
                <button class="btn btn-primary" id="saveEdit">Save changes</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
    (function(){
      // context path same as other pages
      function ctxPath(){ const p = window.location.pathname.split('/').filter(Boolean); return p.length ? '/' + p[0] : ''; }
      const ctx = ctxPath();

      // DOM refs
      const avatarEl = document.getElementById('avatar');
      const profileName = document.getElementById('profileName');
      const profileDept = document.getElementById('profileDept');
      const displayEmail = document.getElementById('displayEmail');
      const displayFullName = document.getElementById('displayFullName');
      const displayDepartment = document.getElementById('displayDepartment');
      const displayExpertise = document.getElementById('displayExpertise');
      const displayOfficeHours = document.getElementById('displayOfficeHours');
      const displayPhone = document.getElementById('displayPhone');
      const displayOfficeLocation = document.getElementById('displayOfficeLocation');
      const displayNumStd = document.getElementById('displayNumStd');

      const toast = document.getElementById('toast');

      const modalBackdrop = document.getElementById('modalBackdrop');
      const editBtn = document.getElementById('editProfileBtn');
      const modalCloseBtn = document.getElementById('modalCloseBtn');
      const cancelEditBtn = document.getElementById('cancelEdit');
      const saveEditBtn = document.getElementById('saveEdit');
      const editForm = document.getElementById('editForm');

      // form fields
      const fld = {
        firstName: document.getElementById('firstName'),
        lastName: document.getElementById('lastName'),
        email: document.getElementById('email'),
        department: document.getElementById('department'),
        expertise: document.getElementById('expertise'),
        officeHours: document.getElementById('officeHours'),
        officeLoc: document.getElementById('officeLoc'),
        phoneNum: document.getElementById('phoneNum'),
        password: document.getElementById('password')
      };

      let advisorData = null;

      function showToast(msg, type='success') {
        toast.className = 'toast ' + (type==='success' ? 'success' : 'error');
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(()=>{ toast.style.display = 'none'; }, 3500);
      }

      function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      function initials(first, last){
        const a = (first||'').trim(), b = (last||'').trim();
        if (!a && !b) return 'AD';
        return ((a? a[0] : '') + (b? b[0] : '')).toUpperCase();
      }

      async function apiGet(path){
        const res = await fetch(ctx + path, { cache:'no-store' });
        if (!res.ok) throw new Error('GET ' + path + ' ' + res.status);
        return res.json();
      }

      async function apiPost(path, body){
        const res = await fetch(ctx + path, {
          method: 'POST',
          body: body,
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });
        const txt = await res.text();
        try { return JSON.parse(txt); }
        catch(e){ return { ok: res.ok, status: res.status, text: txt }; }
      }

      // populate UI from /api/advisor/me
      async function loadAdvisor(){
        try {
          const data = await apiGet('/api/advisor/me');
          if (!data) return;
          advisorData = data.advisor || data; // allow both shapes
          const adv = advisorData || {};
          const first = adv.firstName || adv.firstname || '';
          const last = adv.lastName || adv.lastname || '';
          const full = ((first + ' ' + last).trim()) || adv.email || '';
          avatarEl.textContent = initials(first, last);
          profileName.textContent = full;
          profileDept.textContent = adv.department || 'Academic Advisor';
          displayEmail.textContent = adv.email || '';
          displayFullName.textContent = full;
          displayDepartment.textContent = adv.department || '';
          displayExpertise.textContent = adv.expertise || '';
          // office hours may contain newlines
          if (adv.officeHours) {
            displayOfficeHours.innerHTML = escapeHtml(adv.officeHours).replace(/\n/g,'<br/>');
          } else displayOfficeHours.textContent = '';
          displayPhone.textContent = adv.phoneNum || adv.phone || '';
          displayOfficeLocation.textContent = adv.officeLoc || adv.officeLocation || '';
          const numSTD = (adv.numSTD === null || typeof adv.numSTD === 'undefined') ? '' : adv.numSTD;
          const maxSTD = (adv.maxSTD === null || typeof adv.maxSTD === 'undefined') ? '' : adv.maxSTD;
          displayNumStd.textContent = (numSTD || maxSTD) ? `${numSTD || 0} / ${maxSTD || '—'}` : '—';
        } catch (err){
          console.error('loadAdvisor', err);
          showToast('Could not load advisor data', 'error');
        }
      }

      // open modal and prefill fields
      function openEditModal(){
        if (!advisorData) {
          // ensure we have data
          loadAdvisor().then(() => fillForm()).catch(()=>fillForm());
        } else fillForm();
        modalBackdrop.style.display = 'flex';
        modalBackdrop.setAttribute('aria-hidden','false');
        // focus first field
        setTimeout(()=> fld.firstName.focus(), 80);
      }

      function fillForm(){
        const d = advisorData || {};
        fld.firstName.value = d.firstName || d.firstname || '';
        fld.lastName.value = d.lastName || d.lastname || '';
        fld.email.value = d.email || '';
        fld.department.value = d.department || '';
        fld.expertise.value = d.expertise || '';
        fld.officeHours.value = d.officeHours || d.officehours || '';
        fld.officeLoc.value = d.officeLoc || d.officeloc || '';
        fld.phoneNum.value = d.phoneNum || d.phone || '';
        fld.password.value = '';
      }

      function closeModal(){
        modalBackdrop.style.display = 'none';
        modalBackdrop.setAttribute('aria-hidden','true');
      }

      // simple client validation
      function validateForm(){
        const errors = [];
        if (!fld.firstName.value.trim()) errors.push('First name required');
        if (!fld.lastName.value.trim()) errors.push('Last name required');
        const em = fld.email.value.trim();
        if (!em) errors.push('Email required');
        else {
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!re.test(em)) errors.push('Email is invalid');
        }
        return errors;
      }

      async function saveProfile(){
        const errs = validateForm();
        if (errs.length) {
          showToast(errs.join(' • '), 'error');
          return;
        }

        // build payload
        const params = new URLSearchParams();
        params.append('firstName', fld.firstName.value.trim());
        params.append('lastName', fld.lastName.value.trim());
        params.append('email', fld.email.value.trim());
        params.append('department', fld.department.value.trim());
        params.append('expertise', fld.expertise.value.trim());
        params.append('officeHours', fld.officeHours.value.trim());
        params.append('officeLoc', fld.officeLoc.value.trim());
        params.append('phoneNum', fld.phoneNum.value.trim());
        if (fld.password.value) params.append('password', fld.password.value);

        saveEditBtn.disabled = true;
        saveEditBtn.textContent = 'Saving...';

        try {
          const res = await apiPost('/api/advisor/update', params);
          if (res && res.success) {
            showToast('Profile updated', 'success');
            closeModal();
            // refresh UI
            await loadAdvisor();
          } else {
            console.warn('update response', res);
            showToast(res.error || res.message || 'Update failed', 'error');
          }
        } catch (err) {
          console.error('saveProfile', err);
          showToast('Network error updating profile', 'error');
        } finally {
          saveEditBtn.disabled = false;
          saveEditBtn.textContent = 'Save changes';
        }
      }

      // logout with confirm
      function logout(){
        if (!confirm('Are you sure you want to logout?')) return;
        window.location.href = ctx + '/logout';
      }

      // wire events
      document.addEventListener('DOMContentLoaded', function(){
        loadAdvisor();

        editBtn.addEventListener('click', openEditModal);
        modalCloseBtn.addEventListener('click', closeModal);
        cancelEditBtn.addEventListener('click', closeModal);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('profileHomeBtn').addEventListener('click', ()=> window.location.href = 'advisor_dashboard.html');

        // close modal on ESC
        document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closeModal(); });

        saveEditBtn.addEventListener('click', function(ev){
          ev.preventDefault();
          saveProfile();
        });

        // click outside modal closes
        modalBackdrop.addEventListener('click', function(e){
          if (e.target === modalBackdrop) closeModal();
        });
      });
    })();
    </script>
</body>
</html>